#!/usr/bin/env node

var argv = require('optimist').argv,
	path = require('path'),
	url = require('url'),
	_ = require('underscore');

var appjs = require('../lib/appjs'),
	Loader = require('../lib/Loader').Loader,
	PageMaker = require('../lib/PageMaker').PageMaker,
	WebServer = require('../lib/WebServer');

// Allows you to import the package located in the current working directory
require.paths.unshift(path.resolve('..'));

var defaults = {
	inlineScripts: true,
	inlineStyles: true,
	inlineImages: true,
	inlineContent: true,
	compress: true,
};

var options = {
	inlineScripts: 'inlineScripts' in argv ? argv.inlineScripts != 'false'
				   : ('inline' in argv ? argv.inline != 'false' : defaults.inlineScripts),
	inlineStyles: 'inlineSTyles' in argv ? argv.inlineStyles != 'false'
				   : ('inline' in argv ? argv.inline != 'false' : defaults.inlineStyles),
	inlineImages: 'inlineImages' in argv ? argv.inlineImages != 'false'
				   : ('inline' in argv ? argv.inline != 'false' : defaults.inlineImages),
	inlineImages: 'inlineImages' in argv ? argv.inlineImages != 'false'
				   : ('inline' in argv ? argv.inline != 'false' : defaults.inlineImages),
	compress: 'compress' in argv ? argv.compress != 'false' : defaults.compress,
};

var moduleName = argv._[0];

if (!moduleName) {
	console.log("Module name required.");
} else {
	var loader = new Loader();

	appjs.loadApp(moduleName, loader, function(err, app) {
		if (err) { console.log('Unable to find module ' + moduleName); return; }

		if (argv.dependencies) {
			loader.traceDependencies(moduleName, true, function(err, results) {					
				console.log(results);
			});
		} else if (argv.render) {	
			var targetURL = typeof(argv.render) == 'string' ? argv.render : '/';
			var localURL = url.format({protocol: 'http', hostname: "localhost", port:8081});
			var baseURL = "/";
			var pageMaker = new PageMaker(app, localURL, baseURL);

			loader.loadURL(targetURL, pageMaker, options, function(err, result) {
				console.log(result.source);
			});
		} else if (argv.server) {
			WebServer.serve(app, parseInt(argv.port), options);
		}
	});	
}

